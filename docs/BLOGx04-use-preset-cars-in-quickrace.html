<!DOCTYPE html><html lang='en'><head><meta charset=utf-8>
<title>nfsu2-re/BLOGx04: Use preset cars in quickrace</title>
<style>
body {
	font-family: Tahoma,Arial,sans-serif;
	background: #888;
	color: #000;
}
header,
body > div {
	background: #fff;
	box-shadow: 0px 0px 4px #000;
	border: 1px solid #efefef;
	padding: 0 1em;
	margin: 1em auto;
	max-width: 60em;
}
h1 {
	margin: .3em;
}
header {
	background: #eee;
	text-align: center;
}
nav {
	line-height: 2em;
	margin: 1em 0;
}
nav a {
	padding: .2em .5em;
	background: #ddd;
	border-color: #555;
	border-style: ridge;
	border-width: 2px;
}
pre,
.sym > div:not(.mm) {
	margin: 1em 0;
	padding: .2em .5em;
	font-family: monospace;
	white-space: pre;
	overflow-x: auto;
}
pre {
	border: 2px solid #cdcdcd;
	background: #f7f7f7;
}
blockquote {
	background: #eee;
	border-left: 5px solid #aaa;
	padding: 1em;
	margin: 1em;
}
table {
        border-collapse: collapse;
}
td,th {
	padding: .1em .4em;
	border: 1px solid #000;
}
th {
        background: #f5f5f5;
}
details {
        padding: .2em .4em 0 .4em;
        margin: .5em 0;
        border: 1px solid #ccc;
        background: #eee;
}
summary {
        user-select: none;
        cursor: pointer;
}
.mm a[href^="funcs.html"],
.mm a[href^="vars.html"],
.mm a[href^="structs.html"],
.mm a[href^="enums.html"] {
	border-radius: 5px;
	padding: 0 .15em;
	font-family: monospace;
}
.mm a[href^="funcs.html"]:hover {
	background: #fdf;
}
.mm a[href^="vars.html"]:hover {
	background: #dfd;
}
.mm a[href^="structs.html"]:hover {
	background: #ddf;
}
.mm a[href^="enums.html"]:hover {
	background: #fdd;
}
nav a[href^="funcs.html"],
.mm a[href^="funcs.html"],
.func > div:not(.mm),
.struc > ul > li > pre {
	background: #fef;
	border-color: #f6f;
}
/*struc methods*/
.struc > ul > li > pre {
	white-space: pre-wrap;
	margin: -1px 0 0 0;
}
.struc > ul {
	margin: 0 0 1em 0;
	list-style: none;
	padding: 0;
}
.sym.struc > div {
	margin-bottom: 0;
}
.struc > div + a + div, .struc > ul + a + div {
	margin-top: 1em;
}
nav a[href^="structs.html"],
.mm a[href^="structs.html"],
.struc > div:not(.mm) {
	background: #eef;
	border-color: #66f;
}
nav a[href^="enums.html"],
.mm a[href^="enums.html"],
.enum > div:not(.mm) {
	background: #fee;
	border-color: #f66;
}
nav a[href^="vars.html"],
.mm a[href^="vars.html"],
.var > div:not(.mm) {
	background: #efe;
	border-color: #5a5;
}
.sym > div:not(.mm),
/*struc methods*/
.struc > ul > li > pre {
	border-width: 1px;
	border-style: solid;
}
div h3 {
	display: inline;
	font-size: 1em;
	font-weight: bold;
}
body > div > ul i,
body > div > div i {
	font-style: normal;
	font-size: 80%;
	color: #777;
}
/*class label*/
.struc h2 + ul em::after,
.struc h3 + i + em::after {
	content: "/*class*/";
	font-style: normal;
	background: #d4aaff;
	border: 1px solid #94f;
	font-size: 80%;
	border-radius: 3px;
}
.struc h2 + ul em::after {
	content: "class";
	padding: 0 .2em;
}
/*union emphasis/label*/
.struc h2 + ul b::after,
body > div > div b {
	font-weight: normal;
	background: #aadfff;
	border: 1px solid #44b9ff;
	font-size: 90%;
	border-radius: 3px;
}
.struc h2 + ul b::after {
	content: "union";
	padding: 0 .2em;
	font-size: 80%;
}
.struc h2 + ul b {
	font-weight: normal;
}
/*unknown type*/
body > div > div u {
	text-decoration: none;
}
span.uctype,
body > div > div u::after {
	content: "/*unconfirmed type*/";
	background: #fca;
	border: 1px solid #f94;
	font-size: 80%;
	border-radius: 6px;
	color: #000;
}
/*reference to unknown struct/enum*/
.mm .error,
body > div.sym > div strong {
	background: #f00;
	color: #fff;
}
/*doccomment*/
body > div > div > span {
	color: #080;
	display: inline-block;
	margin-left: 5em; /*why 5 and not 8?*/
	/*so doccomments on their own don't cause scrollbars*/
	white-space: pre-wrap;
}
a.ext::after {
	display: inline-block;
	content: '';
	width: 12px;
	height: 12px;
	background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAM\
AgMAAAArG7R0AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQ\
AAAAJUExURUdwTAD/AAAA//ENIZIAAAABdFJOUwBA5thmAAAAL0lEQVQI12NggAFRBwaG0AQGptAVDF\
wzsxi4Zq1k4JqaCcZMU1cwMCxbwMCg1QAArE8JoyhJwYoAAAAASUVORK5CYII=') no-repeat;
}
/*symbol comments*/
.sym div.mm {
	background: #efefef;
	border: 1px dashed #000;
	border-bottom: 0;
	margin-bottom: 0;
	padding: .2em .5em;
}
.sym div.mm + div {
	margin-top: 0;
}
/*mm stuff mostly used in docs*/
div.mm div {
	margin: 2em 0;
	padding-left: 1em;
	border-left: 3px ridge #666;
}
div.mm p.center {
	text-align: center;
}
div.mm p.imgholder {
	text-align: center;
	margin: 3em 0;
}
code {
	background: #dfdfdf;
	padding: 0 .2em;
	border-radius: 3px;
}
div.mm h2 a, div.mm h3 a, div.mm h4 a, div.mm h5 a, div.mm h6 a {
	color: #A0A0A0;
}
pre.ida {
	color: #000080;
	font-weight: bold;
}
pre.ida span.text,
pre.ida span.mt {
	color: #000;
}
pre.ida span.comment,
pre.ida span.mc {
	color: #808080;
}
pre.ida span.ident {
	color: #0000ff;
}
pre.ida span.num, pre.ida span.str {
	color: #008000;
}
pre.ida span.hi {
	background: #ff0;
}
</style></head><body>
<header>
<h1>nfsu2-re</h1>
<p><a href='https://github.com/yugecin/nfsu2-re'>https://github.com/yugecin/nfsu2-re</a></p>
<nav><a href='index.html'>home</a>
<a href='blog.html'>blog</a>
<a href='docs.html'>docs</a>
<a href='funcs.html' class='func'>functions</a>
<a href='structs.html' class='struc'>structs</a>
<a href='enums.html' class='enum'>enums</a>
<a href='vars.html' class='var'>variables</a>
<a href='cheatsheet.html'>cheatsheet</a></nav>
</header>
<div class='mm'>
<p><a href='blog.html'>blog</a> &gt; Use preset cars in quickrace (2023 August 7)</p><div><h2 id="usepresetcarsinquickrace">Use preset cars in quickrace <a href='#usepresetcarsinquickrace'>#</a></h2>
<p>Well this didn't take long after last blogpost
(<a href='BLOGx03-customizing-preset-cars.html#customizingpresetcars'>Customizing preset cars</a>).
(you may want to read/skim that one first before going here, as this post
is a continuation really)
<p>Just chasing xrefs to <a href=vars.html#83A9D0>profileData</a>.<a href=structs.html#struc_ProfileData@10>player1</a>.<a href=structs.html#struc_Player@D4>d4</a>.<a href=structs.html#struc_Player_D4@4>currentCarSelectionSlotHash?</a> led me to the code that
initializes the car stuff to use in game. I suspected that that field
would lead me to there because, well, it's the "current selected car".
<p class=center><video controls style=max-width:100%><source src=img/BLOGx04-USE-PRESET-CARS-IN-QUICKRACE.MP4 type=video/mp4></video>
<ul>
<li><a href='#usepresetcarsinquickrace'>Use preset cars in quickrace</a></li>
<li><a href='#reusingcustomizingpresetcars'>Reusing code from customizing preset cars</a></li>
<li><a href='#the'>The only really important code</a></li>
</ul>
<p style='text-align:right'><small><a href='#index'>Index</a></small></p>
</div>
<div><h2 id="reusingcustomizingpresetcars">Reusing code from customizing preset cars <a href='#reusingcustomizingpresetcars'>#</a></h2>
<p>I'm not gonna copy everything in here again, most of it is the same/similar to the
code as in previous blog post.
<p>See <code><a class='ext' href='https://github.com/yugecin/nfsu2-re/blob/master/nfsu2-re-hooks/fun-use-preset-cars-in-quickrace.c'>nfsu2-re-hooks/fun-use-preset-cars-in-quickrace.c</a></code> for all the code together.
<p>Though important implementation notes: because I also don't just wanna copy all code,
I'm relying on the existing code from <code><a class='ext' href='https://github.com/yugecin/nfsu2-re/blob/master/nfsu2-re-hooks/fun-car-customize-preset.c'>nfsu2-re-hooks/fun-car-customize-preset.c</a></code>.
<p>That means the hook for ChangeCategory in this new file will also call the old hook
(because the new hook file relies on the old hook file and I don't want to break the
functionality of the old hook file by including the new hook file, youwithme?)
<p>Also we'll have to override CountAvailableCars_hook again, because we added something
so it returns 0 if we're not in the customization menu. Of course it shouldn't do that
anymore, we need a real count in the quickrace menu too now.
<p style='text-align:right'><small><a href='#index'>Index</a></small></p>
</div>
<div><h2 id="the" importantcode="">The only really important code <a href='#the'>#</a></h2>
<p>So the game crashes if we select a preset car for quick race. The reason is still
the same as we've seen so many times before; it tried to find a car based on its
slot hash. Since the slot hash for our custom preset car entries does not resolve
to a real slot in the car collection, the car will not be found.
<p>The code skips over that and just doesn't call the ApplyTuning method then, but
apparently that is vital because the game crashes... maybe it does more than
ApplyTuning and it sets important things that are not solely tuning things.
Maybe there's no car info at all and it just gets a very empty car instance...
<p>Anyways, we just need to hook in there once more and return the inventory car
instance for the preset cars we made before.
<pre>
static
__declspec(naked)
void
fun_use_preset_cars_in_quickrace_FindPresetCarWhenTuningForIngameCar()
{
	_asm {
		cmp edi, [numPresetCars]
		jb its_preset
		// this is what we overwrote
		add edx, 0x9BD8 // sizeof(struct CarCollection)
		mov ecx, 0x525FC1
		jmp ecx

its_preset:
		imul edi, 0x1C // sizeof(SponsorCar)
		add edi, offset presetCarAsInventoryCar
		mov eax, 0x525FE6
		jmp eax
	}
}

mkjmp(0x525FBB, fun_use_preset_cars_in_quickrace_FindPresetCarWhenTuningForIngameCar);
</pre>
<p>so simple!
<p style='text-align:right'><small><a href='#index'>Index</a></small></p>
</div>

</div></body></html>
